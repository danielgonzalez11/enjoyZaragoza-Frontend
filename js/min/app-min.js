function cleanError(e){var t=e;setTimeout(function(){var e=$(t.form).validate();e.settings.unhighlight&&e.settings.unhighlight.call(e,t,e.settings.errorClass,e.settings.validClass),e.hideThese(e.errorsFor(t))},300)}function scrollTo(e,t){var n=$(window).scrollTop(),r=e.offset().top;t=t||{};var o=t.between||{},i=o.top||r>n?n:r,a=o.bottom||e.offset().top+e.height()-$(window).height();n>i&&(i=n),a>i&&(i=a),i>r&&(i=r),i=parseInt(i),delete t.between,i!==n?$("html, body").animate({scrollTop:i},t):t.complete&&t.complete.call(e[0])}function project(){$(function(){var e=$("#reply-form"),t=e.height();$(document).on("click",".btn-reply",function(){var n=$(this),r=n.data("id"),o=$("#reply-"+r);o.length||(o=$('<div id="reply-'+r+'" class="col-md-offset-1 col-md-11"></div>').hide(),e.clone().removeAttr("id").appendTo(o),o.find('input[name="reply-to"]').val(r),o.find("textarea").val(),o.insertAfter($(this).closest(".comment-wrap")),o.slideDown("slow"),n.attr("href","#reply-"+r));var i=o.find("form");return setTimeout(function(){scrollTo(i,{between:{top:n.closest(".comment-wrap").offset().top,bottom:i.offset().top+t-$(window).height()},complete:function(){i.find("textarea").focus()},duration:"slow"})},1),!1})})}function invest_calc(e,t,n,r,o,i,a,s,l){$(function(){accounting.settings.currency.format="%v %s",accounting.settings.currency.symbol=window.currencySymbol,accounting.settings.currency.precision=0,accounting.settings.number.precision=0,"es_ES"===window.locale?(accounting.settings.number.decimal=",",accounting.settings.number.thousand="."):(accounting.settings.number.decimal=".",accounting.settings.number.thousand=","),$("#amount").numeric({allowPlus:!1,allowMinus:!1,allowThouSep:!1,allowDecSep:!1,allowLeadingSpaces:!1,maxDigits:7,maxDecimalPlaces:0,maxPreDecimalPlaces:0,max:n,min:r}).on("keyup change blur",function(){var n=$(this).val();0===n.length&&(n=0);var a=parseInt(n),c=parseInt(Math.round(a/o));$(".calcShare").html(c);var d=c*o;$(".calcInput").html(accounting.formatNumber(d,2)+" "+window.currencySymbol);var p=parseFloat(d*s)/parseInt(i);$(".calcPercent").html(parseFloat(p).toFixed(2)+"%");var u=parseInt(d*l)/100;$(".calcEstimate").html(accounting.formatNumber(u,2)+" "+window.currencySymbol);var f="/investment/"+t+"/invest/preview/"+e+"/",h="disabled";d>1&&a>=r?($("#realAmount").val(d),$(".btn-contract").attr("href",f+"?amount="+d),$(".btn-contract, .btn-invest").removeClass(h).removeAttr(h)):($("#realAmount").val(""),$(".btn-contract, .btn-invest").addClass(h).attr(h,h))}).change()})}function toggleForm(e,t){var n=e.data(),r="formActive"in n?n.formActive:!0;if(t!==r){var o=$.Event((t?"activate":"deactivate")+".app.form");if(o.oldValue=this.state,e.trigger(o),o.isDefaultPrevented())return;e.data("formActive",t),e.css("opacity",t?"":"0.65"),e.find("label, input, select, button").css("pointer-events",t?"":"none").each(function(e,n){n=$(n);var r=n.data();if("oldTabIndex"in r)t?n.attr("tabindex",r.oldTabIndex===!1?"":r.oldTabIndex):n.attr("tabindex",-1);else if(!t){var o=n.attr("tabindex");n.data("oldTabIndex",o?o:!1).attr("tabindex",-1)}})}}function change_investor_type(e){var t=$("#enterprise, #individual").filter(":checked").val(),n=$("#enterprise").val(),r=$("#individual").val(),o=$("#enterprise-menu"),i=$("#enterprise-form");e&&($("#enterprise-menu, #enterprise-provable-menu").hide(),$("#enterprise-others-disclaimer, #enterprise-profesional-disclaimer").hide(),$("#type-of-investor-group, #custom-type-of-enterprise").hide(),$("#individual-others-disclaimer").hide()),t===n?(e&&$("#individual-form").hide(),i.length?(o.slideDown("slow").find("input:first").change(),$("#type-of-enterprise").change()):o.find("input:checked").prop("checked",!1)):(o.slideUp("slow"),$("#enterprise-provable-menu").hide("slow"),$("#enterprise-profesional-disclaimer, #enterprise-others-disclaimer").slideUp("slow"),$("#acreditable").removeClass("submenu-triangle")),toggleForm($("#individual-form").toggle(t!==n),t===r),$("#enterprise-form").toggle(t===n),$("#individual-others-disclaimer")[t===r?"show":"hide"]("slow")}function investor_form(){$(function(){$("#individual-form").closest("form").validate({rules:{id_number:{idNumber:!0}}}),$("#enterprise-form").closest("form").validate({rules:{e_id_number:{cif:!0}}});var e=$("#acreditable").val(),t=$("#profesional").val(),n=$("#others").val();$(document).on("change","#acreditable, #profesional, #others",function(){var r=$("#enterprise-menu input:checked").val();$("#enterprise-legal-form").val(r),$("#enterprise-provable-menu")[r===e?"show":"hide"]("slow"),$("#enterprise-profesional-disclaimer")[r===t?"slideDown":"slideUp"]("slow"),$("#enterprise-others-disclaimer")[r===n?"slideDown":"slideUp"]("slow"),$("#acreditable")[r===e?"addClass":"removeClass"]("submenu-triangle"),$("#type-of-investor-group")[r===t?"slideDown":"slideUp"]("slow").find("select").prop("disabled",r!==t),r===t||r===n?toggleForm($("#enterprise-form"),!0):$("#enterprise-provable-menu input").first().change()}).on("change","#check-1, #check-2, #check-3",function(){toggleForm($("#enterprise-form"),$("#enterprise-provable-menu input:checked").length>1)}).on("change changed.app.Control","#type-of-enterprise",function(e){"CUSTOM"===this.value&&($(this).hide(),$("#custom-type-of-enterprise").show(),"changed"===e.type&&($(this).data("oldValue",e.oldValue),$("#custom-type-of-enterprise").focus()))}).on("blur","#custom-type-of-enterprise",function(){if(!this.value.trim().length){var e=$("#type-of-enterprise");$(this).hide(),cleanError(this),e.control("edit").control("value",e.data("oldValue")).control("done").show()}}).on("change","#enterprise, #individual",function(){change_investor_type()}),change_investor_type(!0)})}function payment_step2(){$(function(){$("#main-form").validate()})}function payment_step3(){$(function(){$("#main-form").validate()})}function user_settings(e){$(function(){investor_form(),$("#social-form, #avatar-form").validate(),$(document).on("edit.app.Control",".form-control-inline",function(){var t=$(this).removeClass("form-control-inline").addClass("form-control-editing");if("file"!==t.prop("type")){var n=t.closest(".form-group").find(".btn-edit").hide();n.length&&(n.after('<a href="#'+this.id+'" class="btn btn-link btn-cancel" tabindex="-1" data-dismiss="control">'+e.strings.cancel+"</a>"),"textarea"===t.prop("type")&&n.after('<a href="#'+this.id+'" class="btn btn-link btn-save" tabindex="-1" data-save="control">'+e.strings.save+"</a>"))}}).on("closed.app.Control",".form-control-editing",function(){var e=$(this).removeClass("form-control-editing").addClass("form-control-inline");e.closest(".form-group").find(".btn-edit").toggle(!e.hasClass("saving")).nextAll(".btn-save, .btn-cancel").remove()}).on("cancel.app.Control",".form-control-editing",function(){cleanError(this)}).on("changed.app.Control",".form-control-editing",function(t){if("e_type"!==this.name||"CUSTOM"!==this.value){var n=$(this);if(n.closest("form").length&&!n.valid())return void t.preventDefault();var r=n.closest(".radio-inline, .checkbox-inline, .form-group"),o=r.find(".btn-edit"),i=n.prop("type"),a=function(){n.addClass("saving"),"file"!==i&&n.control("disable"),o.length?(o.hide().after('<span class="progress-spinner">'+e.strings.saving+"</span>"),o.nextAll(".btn-save, .btn-cancel").remove()):r.addClass("progress-spinner")},s=function(e){if(e)if("file"===i?o.show():n.control("edit").data("app.control").oldValue=t.oldValue,n[0].form){var a={};a[n[0].name]=e,$(n[0].form).validate().showErrors(a),scrollTo(r)}else window.alert(e),n.control("value",t.oldValue);else o.show();o.length?o.nextAll(".progress-spinner").remove():r.removeClass("progress-spinner"),n.removeClass("saving"),"file"===i?n.replaceWith(n.clone()):n.control("enable")},l;l="file"===i?function(){var t="uploadFrame"+(new Date).getTime(),r=t+"Callback";a(),$('<iframe name="'+t+'" height="0" width="0" frameborder="0" scrolling="no" style="display:none"></iframe>').appendTo("body").on("error",function(){s(e.strings.errorConnection)}),window[r]=function(t,r){if(200===t){if(r=JSON.parse(r),"avatar"===n[0].name)var o=$(n[0].form).find("img"),i=o.clone().on("load",function(){this.width+this.height===0?s(e.strings.errorConnection):(o.replaceWith(i),s())}).on("error",function(){s(e.strings.errorConnection)}).attr("src",r[n[0].name]+"?"+(new Date).getTime())}else s(404===t?e.strings.error404:r)},$(n[0].form).attr("target",t).attr("action","/Ajax/user.php/"+n.prop("name")+"?callback=window.parent."+r).submit()}:function(r){a(),r=r||t.value,$.ajax({url:"/Ajax/user.php/"+n.prop("name"),type:"PUT",data:r,success:function(e,r,o){var i=!0;if(202===o.status)$('<p class="alert alert-info alert-dismissible" role="alert"></p>').text(e).prepend('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>').insertAfter(n);else if("typeof_investor"===n[0].name){if("enterprise"===t.oldValue)$("#settings-enterprise-wrap").html("");else if("enterprise"===t.value){var a=$("#settings-enterprise-wrap");a.html().trim()||(i=!1,$.get("/settings/enterprise/?nodecorate",function(e){a.html(e),change_investor_type(!0),s()}))}}else{var l=JSON.parse(e),c,d;for(c in l)-1!==$.inArray(c,["name","surname","birth_year"])?cleanError($('[name="'+c+'"]').control("value",l[c]).control("close")[0]):(d=n.closest("form").find('[name="'+c+'"]'),d.length&&(d=d.first(),-1===$.inArray(d.prop("type"),["checkbox","radio","password"])&&cleanError(d.control("value",l[c]).control("close")[0])))}i&&s()},error:function(t){s(404===t.status?e.strings.error404:t.responseText)}})},"email"===this.name||"password"===this.name?$("#confirm-pass-modal").data("ok",!1).modal("show").one("hide.bs.modal",function(){if($(this).data("ok")){var e=$("#confirm-pass"),r={};r[t.target.name]=t.value,r[e[0].name]=e[0].value,l(r)}else n.control("value",t.oldValue).blur()}).one("shown.bs.modal",function(){$("#confirm-pass").focus()}):l()}}),$(document).on("submit","#confirm-pass-modal form",function(){return $("#confirm-pass-modal").data("ok",!0).modal("hide"),!1})})}$(document).on("show.bs.tab shown.bs.tab",'a[data-toggle="tab"]',function(e){var t=$($(e.target).attr("href"));t.length&&t.attr("data-url")&&!t.data("tab-loaded")&&(t.load(t.attr("data-url")),t.data("tab-loaded",!0))}),$(document).on("show.bs.modal",".modal-ajax",function(e){var t=$(this),n=$(e.relatedTarget),r=n.data("url"),o=n.data("title"),i=t.find(".modal-loading").show(),a=t.find(".modal-error").hide(),s=t.find(".modal-body").hide().load(r,function(e,t){i.fadeOut("slow"),"error"===t?a.fadeIn("slow"):s.fadeIn("slow")});o&&t.find(".modal-title").text(o)}),$.validator&&($.validator.addMethod("idNumber",function(e){if(e=e.toUpperCase(),0===e.length)return!0;var t=$(this.currentForm).find('[name="document_type"]').val().toUpperCase();if($.validator.messages.idNumber="Por favor, introduce un "+t+" válido.",!e.match("((^[A-Z]{1}[0-9]{7}[A-Z0-9]{1}$|^[T]{1}[A-Z0-9]{8}$)|^[0-9]{8}[A-Z]{1}$)"))return!1;if("NIE"===t){if(/^[T]{1}/.test(e))return e[8]===/^[T]{1}[A-Z0-9]{8}$/.test(e);if(/^[XYZ]{1}/.test(e))return e[8]==="TRWAGMYFPDXBNJZSQVHLCKE".charAt(e.replace("X","0").replace("Y","1").replace("Z","2").substring(0,8)%23)}else{if(/^[0-9]{8}[A-Z]{1}$/.test(e))return"TRWAGMYFPDXBNJZSQVHLCKE".charAt(e.substring(8,0)%23)===e.charAt(8);if(/^[KLM]{1}/.test(e))return e[8]===String.fromCharCode(64)}return!1}),$.validator.addMethod("cif",function(e){e=e.replace(/[\s-]/g,"");var t=0,n=0,r="ABCDEFGHKLMNPQS",o=e.charAt(0),i,a,s,l;if(0===e.length)return!0;if(9!==e.length)return!1;if(-1===r.indexOf(o.toUpperCase()))return!1;for(i=2;8>i;i+=2)t+=parseInt(e.charAt(i));for(i=1;9>i;i+=2)a=2*parseInt(e.charAt(i)),a>9&&(a=1+(a-10)),n+=a;return s=t+n,l=10-s%10,10===l&&(l=0),l!==parseInt(e.charAt(8))?!1:!0},"Por favor, introduce un CIF válido."));var Control=function(e){this.$element=$(e),this.editing=!1,this.oldValue=null,this.type=this.$element.prop("tagName").toLowerCase(),"input"===this.type&&(this.type=this.$element.prop("type"),-1===$.inArray(this.type,["checkbox","radio","file"])&&(this.type="text")),("text"===this.type||"textarea"===this.type)&&this.$element.on("keyup",$.proxy(function(e){"text"===this.type&&13===e.keyCode&&this.done(),27===e.keyCode&&this.cancel()},this))};Control.prototype.getInputs=function(){if(!this.$element[0].name)return this.$element;var e=this.$element.closest("body, form"),t=e.find(":input[name="+this.$element[0].name+"]");return e.is("body")&&t.not("form :input"),t},Control.prototype.value=function(e){var t=this.$element,n,r=-1,o;if(arguments.length){if("radio"===this.type)for(n=this.getInputs();++r<n.length;)o=$(n[r]),o.prop("checked",o.val()===e);else if("checkbox"===this.type)if(Array.isArray(e))for(n=this.getInputs();++r<n.length;)o=$(n[r]),o.prop("checked",-1!==$.inArray(o.val(),e));else t.prop("checked",t.val()===e);else t.val(e);return void t.change()}if("radio"===this.type)return n=this.getInputs().filter(":checked"),n.length?n.val():null;if("checkbox"===this.type){if(n=this.getInputs(),n.length<=1)return n.is(":checked")?n.val():null;var i=[];return n.filter(":checked").each(function(){i.push($(this).val())}),i}return t.val()},Control.prototype.edit=function(){if(!this.editing){var e=$.Event("edit.app.Control");this.$element.trigger(e),e.isDefaultPrevented()||(this.oldValue=this.value(),this.editing=!0)}},Control.prototype.cancel=function(){if(this.editing){var e=$.Event("cancel.app.Control");e.oldValue=this.oldValue,this.$element.trigger(e),e.isDefaultPrevented()||(this.value()!==this.oldValue&&this.value(this.oldValue),this.close())}},Control.prototype.done=function(){if(this.editing){var e=this.$element,t=this.value();if(t!==this.oldValue||"file"===this.type){var n=$.Event("changed.app.Control");if(n.oldValue=this.oldValue,n.value=t,e.trigger(n),n.isDefaultPrevented())return}this.close()}},Control.prototype.close=function(){if(this.editing){var e=this.$element,t=$.Event("close.app.Control");e.trigger(t),t.isDefaultPrevented()||(this.editing=!1,this.oldValue=null,e.is(":focus")&&e.blur(),e.trigger("closed.app.Control"))}},Control.prototype.disable=function(){if(this.editing&&this.close(),"checkbox"!==this.type&&"radio"!==this.type){var e=this.getInputs();e.each(function(){$(this).control("cancel").prop("disabled",!0)})}else this.$element.prop("disabled",!0)},Control.prototype.enable=function(){if("checkbox"!==this.type&&"radio"!==this.type){var e=this.getInputs();e.each(function(){$(this).prop("disabled",!1)})}else this.$element.prop("disabled",!1)},$.fn.control=function(e){for(var t=Array.prototype.slice.call(arguments,1),n=-1;++n<this.length;){var r=this[n],o=$(r),i=o.data("app.control");if((i||!/cancel/.test(e))&&(i||o.data("app.control",i=new Control(r)),"string"==typeof e)){var a=i[e].apply(i,t);if("value"===e&&!t.length||"getInputs"===e)return a}}return this},$(document).on("focus.app.Control",":input",function(){$(this).control("edit")}).on("click.app.Control","[data-dismiss=control]",function(){var e=$(this);return $(e.data("target")||e.attr("href")).control("cancel"),!1}).on("click.app.Control","[data-save=control]",function(){var e=$(this);return $(e.data("target")||e.attr("href")).control("done"),!1}).on("change.app.Control blur.app.Control",":input",function(e){var t=$(this),n=t.data("app.control");if(n&&n.editing){if("change"===e.type){if("text"===n.type||"textarea"===n.type)return}else{if("file"===n.type)return;var r=e.relatedTarget&&$(e.relatedTarget);if(r&&"control"===r.data("dismiss")){var o="#"+e.target.id;if(r.data("target")===o||r.attr("href")===o)return void t.control("cancel")}}t.control("done")}});